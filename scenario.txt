## Control host

# Start Openbsd instance (ami-17110571)
# Connect
ssh ec2-user@

# How did my key get there?
ftp -MVo - http://169.254.169.254/latest/meta-data
ftp -MVo - http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key

# When is it executed?
cat /etc/hostname.xnf0
cat /usr/local/libexec/ec2-init

# What permissions do I have?
does cat /etc/doas.conf

# A few words on cloud-init

# terraform
pkg_info -Q terraform
doas pkg_add terraform

# Git
doas pkg_add git
git clone git@github.com:lbernail/eurobsdcon2017.git

# Create VPC
mkdir .aws
^D
scp -r .aws/credentials ec2-user@:.aws
ssh ec2-user@
export AWS_PROFILE=lbernail-admin
cd eurobsdcon2017/terraform/vpc
terraform init
terraform plan
terraform apply

Show VPC
Show instances in that VPC

# Consul cluster
cd ../consul
terraform init
terraform apply
# check for instance profile bug

ssh ec2-user@54.76.11.26 -L 8500:10.0.128.200:8500
Go to UI

Connect to a consul instance
ssh 10.0.128.100
consul members

# Consul configuration
ftp -MVo - http://169.254.169.254/latest/user-data

Show userdata, tags and role in AWS console


# Build VPN
terraform init
terraform apply

# Connect
ssh 10.0.0.10
ftp -MVo - http://169.254.169.254/latest/user-data

consul members
rcctl check consul consul_template
cat /etc/consul-template.d/default.conf
doas cat /etc/ipsec.conf

# Build VPN
connect to us-east, launch instance with ICMP sg
show VPN configuration
Download configuration

# Test ping
ping 172.30.0.x

# Configure keys in consul
look at ipsec conf
retry ping

